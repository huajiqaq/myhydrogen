<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <title>Hydrogen更新日志</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-weight: 300;
            font-size: 36px;
            margin-bottom: 20px;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .date {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .version {
            font-weight: 400;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .update {
            font-weight: 300;
            margin-bottom: 5px;
        }

        .download-btn {
            padding: 10px 20px;
            background-color: #2196f3;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .download-btn:hover {
            background-color: #1e88e5;
        }

        #loader {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>更新日志</h1>
        <ul id="update-log"></ul>
        <div id="loader">加载中...</div>
    </div>

    <script>
        const accessToken = 'abd6732c1c009c3912cbfc683e10dc45';
        const repoOwner = 'huaji110';
        const repoName = 'huajicloud';
        let filePaths = ['zhihu_hydrogen.html', 'hydrogen.html'];
        let currentPage = 0;
        let currentFilePathIndex = 0;
        let Version = '';
        let commitDatas = [];
        const batchSize = 5;
        const updateLogElement = document.getElementById('update-log');
        const loaderElement = document.getElementById('loader');

        const fetchJson = async (url) => {
            try {
                const response = await fetch(url);
                return response.json();
            } catch (error) {
                console.error('Error fetching JSON:', error);
                return null;
            }
        };

        const b64ToUtf8 = (str) => decodeURIComponent(escape(window.atob(str)));

        const createUpdateItem = ({ date, version, changes, downloadLink }) => `
            <li>
                <div>
                    <div class="date">${date}</div>
                    <div class="version">${version}</div>
                    <p class="update">${changes}</p>
                </div>
                <a class="download-btn" href="${downloadLink}" target="_blank">下载</a>
            </li>
        `;

        const addItems = (updates) => {
            updates.forEach(update => {
                const itemHtml = createUpdateItem(update);
                updateLogElement.insertAdjacentHTML('beforeend', itemHtml);
            });
        };

        const parseContent = (content) => {
            const regex = /(\w+)=(.+?),/g;
            let match;
            const result = {};
            while ((match = regex.exec(content)) !== null) {
                result[match[1]] = match[2].replace(/\r\n/g, '');
            }
            return result;
        };

        const fetchCommitContent = async () => {
            loaderElement.innerText = "加载中...";
            if (!commitDatas.length) {
                currentPage++;
                const url = `https://gitee.com/api/v5/repos/${repoOwner}/${repoName}/commits?access_token=${accessToken}&path=${filePaths[currentFilePathIndex]}&page=${currentPage}`;
                const commits = await fetchJson(url);

                if (!commits || commits.length === 0) {
                    if (currentFilePathIndex + 1 < filePaths.length) {
                        currentFilePathIndex++;
                        currentPage = 0;
                        commitDatas = [];
                    } else {
                        window.removeEventListener('scroll', scrollFunc);
                        loaderElement.innerText = "没有更多内容了";
                        return;
                    }
                } else {
                    commitDatas.push(...commits.map(commit => ({
                        time: new Date(commit.commit.committer.date).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }),
                        sha: commit.sha
                    })));
                }
            }

            const updates = [];
            for (let i = 0; i < batchSize && commitDatas.length; i++) {
                const commitData = commitDatas.shift();
                const contentUrl = `https://gitee.com/api/v5/repos/${repoOwner}/${repoName}/contents/${filePaths[currentFilePathIndex]}?access_token=${accessToken}&ref=${commitData.sha}`;
                const data = await fetchJson(contentUrl);
                if (!data) continue;

                const content = b64ToUtf8(data.content);

                const result = parseContent(content);

                const date = commitData.time;
                const version = `${result.updateversionname} ${result.updateversioncode}`;
                const changes = result.updateinfo;
                const downloadLink = result.updateurl;

                if (date && version && changes && downloadLink && version !== Version) {
                    Version = version;
                    updates.push({ date, version, changes, downloadLink });
                }
            }

            addItems(updates);
            loaderElement.innerText = updates.length ? "拉动加载更多内容" : "没有更多内容了";
        }


        let canload = true
        const loadUpdates = async () => {
            if (canload == false) return
            canload = false
            await fetchCommitContent()
            canload = true
        };

        const scrollFunc = () => {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            if (scrollTop + clientHeight >= scrollHeight - 150) {
                loadUpdates();
            }
        };

        window.addEventListener('scroll', scrollFunc);
        loadUpdates();
    </script>
</body>

</html>
