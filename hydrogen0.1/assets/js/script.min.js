document.querySelectorAll(".datepicker").forEach((function (e) { new Pikaday({ field: e }) }));

var originstr = document.querySelectorAll(".btn")[0].innerText
var is_downloading


function download(downurl, name) {

    is_downloading = true

    const xhr = new XMLHttpRequest();
    xhr.open('GET', downurl, true);
    xhr.responseType = 'blob';


    xhr.addEventListener("progress", updateProgress);
    xhr.addEventListener("load ", transferComplete);
    xhr.addEventListener("error", transferFailed);
    xhr.addEventListener("abort", transferCanceled);

    // 服务端到客户端的传输进程（下载）
    function updateProgress(oEvent) {
        if (oEvent.lengthComputable) {
            document.querySelectorAll(".btn")[0].innerText = originstr + "(" + parseFloat(((oEvent.loaded / oEvent.total) * 100).toFixed(2)) + "%)";
            // ...
        } else {
            // 总大小未知时不能计算进程信息
        }
    }

    function transferComplete(evt) {
        is_downloading = false
        document.querySelectorAll(".btn")[0].innerText = originstr
        console.log("下载成功");
    }

    function transferFailed(evt) {
        is_downloading = false
        document.querySelectorAll(".btn")[0].innerText = originstr
        alert("下载失败");
    }

    function transferCanceled(evt) {
        is_downloading = false
        document.querySelectorAll(".btn")[0].innerText = originstr
        alert("异常中断")
    }


    xhr.onload = () => {
        is_downloading = false
        document.querySelectorAll(".btn")[0].innerText = originstr
        const blob = xhr.response;
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = name;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
    };

    xhr.send();
}

function loading() {

    if (is_downloading == true) {
        return alert("下载中")
    }

    // 创建 XHR 对象
    const xhr = new XMLHttpRequest();

    // 设置请求方法和 URL
    xhr.open('GET', 'https://gitee.com/api/v5/repos/huaji110/huajicloud/contents/zhihu_hydrogen.html?access_token=abd6732c1c009c3912cbfc683e10dc45');

    // 发送请求
    xhr.send();

    // 请求加载完成,处理响应
    xhr.onload = function () {
        if (xhr.status === 200) {
            // 解析响应内容
            var downjson = JSON.parse(xhr.responseText)
            var downcontent = atob(downjson.content)
            var downurl = downcontent.match(/updateurl=(\S*),updateurl/)[1]
            var appname = "Hydrogen"
            var versionnamme = downcontent.match(/updateversionname=(\S*),updateversionname/)[1]
            var versioncode = downcontent.match(/updateversioncode=(\S*),updateversioncode/)[1]
            var name = appname + "_" + versionnamme + "_" + versioncode + ".apk"
            download(downurl, name)
        }
    }

    // 请求错误处理
    xhr.onerror = function () {
        console.log('Request Error...');
    }
}